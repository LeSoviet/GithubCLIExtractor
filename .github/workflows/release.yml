name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  id-token: write

jobs:
  # Build and test before release
  pre-release:
    name: Pre-release Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'


      - name: Install dependencies
        run: npm install

      - name: Run code quality checks
        run: npm run lint

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Build project
        run: npm run build

      - name: Verify build artifacts
        run: |
          test -f dist/index.js || exit 1
          test -f dist/index.cjs || exit 1
          test -f dist/index.d.ts || exit 1

  # Create GitHub release
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: pre-release
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'


      - name: Install dependencies
        run: npm install

      - name: Build project
        run: npm run build

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Extract changelog from CHANGELOG.md
        id: changelog
        run: |
          VERSION=${{ steps.version.outputs.version }}

          # Extract the section for this version from CHANGELOG.md
          CHANGELOG=$(awk -v version="$VERSION" '
            /^## \['$VERSION'\]/ { flag=1; next }
            /^## \[/ { if(flag) exit }
            flag { print }
          ' CHANGELOG.md)

          # If no specific changelog found, use a default message
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="No specific changelog found for version $VERSION"
          fi

          # Write to output
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          body: |
            # ðŸš€ Release v${{ steps.version.outputs.version }}

            ${{ steps.changelog.outputs.changelog }}

            ## ðŸ“¦ Installation
            ```bash
            npm install -g ghextractor@${{ steps.version.outputs.version }}
            ```

            ## ðŸ”— Links
            - ðŸ“– [Full Changelog](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)
            - ðŸ“š [Documentation](https://lesoviet.github.io/GithubCLIExtractor/)
            - ðŸ“¦ [npm Package](https://www.npmjs.com/package/ghextractor)
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
          files: |
            dist/**/*
            LICENSE
            README.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Publish to npm using GitHub's provenance
  publish-npm:
    name: Publish to npm
    runs-on: ubuntu-latest
    needs: release
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: npm install

      - name: Build project
        run: npm run build

      - name: Publish to npm
        run: npm publish --provenance --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # Fallback publish to npm without provenance if the above fails
  publish-npm-fallback:
    name: Fallback Publish to npm
    runs-on: ubuntu-latest
    needs: [release, publish-npm]
    if: failure()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: npm install

      - name: Build project
        run: npm run build

      - name: Publish to npm (fallback)
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # Post-release notifications
  notify:
    name: Post-release Notifications
    runs-on: ubuntu-latest
    needs: [release, publish-npm, publish-npm-fallback]
    if: always()
    steps:
      - name: Create release summary
        run: |
          echo "# ðŸŽ‰ Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Release: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Status" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub Release: ${{ needs.release.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- npm Publish: ${{ needs.publish-npm.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- npm Publish (Fallback): ${{ needs.publish-npm-fallback.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Links" >> $GITHUB_STEP_SUMMARY
          echo "- [GitHub Release](https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }})" >> $GITHUB_STEP_SUMMARY
          echo "- [npm Package](https://www.npmjs.com/package/ghextractor)" >> $GITHUB_STEP_SUMMARY
